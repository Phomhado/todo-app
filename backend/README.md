# Backend Documentation

## Overview
This directory contains the backend API for the Todo App, built with Ruby on Rails. It provides endpoints for user authentication, user management, and task management, using JWT for secure authentication.

## Architecture
- **Language:** Ruby 3.3.0
- **Framework:** Rails 7.1.5
- **Database:** PostgreSQL
- **Authentication:** JWT (JSON Web Tokens)
- **Password Security:** bcrypt

## Database setup
1. Ensure PostgreSQL is installed and running locally.
2. Provision the required role and databases (the script is idempotent):
   ```bash
   cd backend
   psql -U postgres -f db/postgres_setup.sql
   ```
   The script creates a superuser role `Phomhado` with password `Phomhado00`,
   plus the `backend_development` and `backend_test` databases owned by that
   role. Adjust the `-U` flag if your PostgreSQL superuser is named
   differently.
3. Export environment variables if you need to override the defaults defined
   in `config/database.yml`:
   ```bash
   export POSTGRES_HOST=localhost
   export POSTGRES_USER=Phomhado
   export POSTGRES_PASSWORD=Phomhado00
   export POSTGRES_DB=backend_development
   export POSTGRES_TEST_DB=backend_test
   ```
4. Install gems and prepare the schema:
   ```bash
   cd backend
   bundle install
   bin/rails db:prepare
   ```
5. Start the Rails server (`bin/rails server`) and connect with RubyMine using
   the same database credentials to inspect the schema and data.

### Folder Structure (Key Parts)
- `app/controllers/api/v1/` — API controllers for version 1
- `app/models/` — Data models (User, Task)
- `config/routes.rb` — API route definitions

## API Endpoints
All endpoints are prefixed with `/api/v1/`.

### Authentication
- `POST /api/v1/login`
  - **Body:** `{ email, password }`
  - **Response:** JWT token and user info on success

### Users
- `POST /api/v1/users`
  - **Body:** `{ name, email, password }`
  - **Response:** Created user info or validation errors
- `GET /api/v1/users/:id`
  - **Response:** User info or not found error

### Tasks
- `GET /api/v1/tasks`
  - **Response:** List of tasks for the authenticated user
- `POST /api/v1/tasks`
  - **Body:** `{ title, description, due_date, column, done_at }`
  - **Response:** Created task or validation errors
- `GET /api/v1/tasks/:id`
  - **Response:** Task details or not found error
- `PUT/PATCH /api/v1/tasks/:id`
  - **Body:** Any updatable task fields
  - **Response:** Updated task or errors
- `DELETE /api/v1/tasks/:id`
  - **Response:** No content on success or error message

## Models

### User
- **Fields:** `name`, `email`, `password_digest`
- **Validations:**
  - Name: presence
  - Email: presence, uniqueness
  - Password: min 8 chars, at least one uppercase, one lowercase, one number
- **Associations:**
  - _Intended_: `has_many :tasks` (association still needs to be added to the
    model code)
- **Authentication:** Uses `has_secure_password` (bcrypt)

### Task
- **Fields:** `title`, `description`, `due_date`, `column`, `done_at`, `user_id`
- **Associations:**
  - Belongs to user

## Authentication
- Uses JWT for stateless authentication.
- On login, a JWT is issued containing the user ID and expiry (24h).
- Most endpoints require the token in the `Authorization` header.

## Error Handling
- Standard JSON error responses, e.g.:
  - `{ error: 'Invalid email or password' }` (401)
  - `{ errors: [...] }` for validation issues (422)
  - `{ error: 'Task not found' }` (404)

## Implementation status notes
- `ApplicationController` expects an `Authorization` header that contains a
  bearer token generated by `Api::V1::AuthController#login`.
- `Api::V1::TasksController#index`, `create`, `update`, and `destroy` rely on
  the authenticated `@current_user` and appear to follow REST conventions.
- `Api::V1::TasksController#show` mistakenly builds a new task instead of
  loading an existing record by ID, so it always returns the request payload
  rather than the persisted task.
- `Api::V1::UsersController` successfully exposes `create` and `show`, but the
  `User` model is missing the `has_many :tasks` association that the README
  previously documented.
- JWTs are encoded using `Rails.application.secrets.secret_key_base`; ensure
  the secret is configured in credentials so tokens can be issued and decoded
  reliably.
- Additional request specs or controller tests have not been implemented yet,
  so test coverage is currently absent.
